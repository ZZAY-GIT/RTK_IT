#!/bin/bash

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º "–ª–æ–≤—É—à–∫—É" –Ω–∞ —Å–∏–≥–Ω–∞–ª—ã SIGINT (Ctrl+C) –∏ SIGTERM.
# –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∏–≥–Ω–∞–ª–∞ –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è cleanup.
trap cleanup SIGINT SIGTERM

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–æ–Ω–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
cleanup() {
    echo ""
    echo "üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É. –ó–∞–≤–µ—Ä—à–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
    if [ ! -z "$PID_NPM" ]; then
        echo "  - –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º npm (PID: $PID_NPM)..."
        kill $PID_NPM
    fi
    
    if [ ! -z "$PID_MAIN" ]; then
        echo "  - –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º main.py (PID: $PID_MAIN)..."
        kill $PID_MAIN
    fi

    if [ ! -z "$PID_EMULATOR" ]; then
        echo "  - –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º emulator.py (PID: $PID_EMULATOR)..."
        kill $PID_EMULATOR
    fi

    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    echo "  - –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä 'rtk_it'..."
    docker stop rtk_it
    
    echo "‚úÖ –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."
    exit 0
}

# --- –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ ---

echo "–ó–∞–ø—É—Å–∫–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä 'rtk_it'..."
docker start rtk_it &
# PID –∫–æ–º–∞–Ω–¥—ã docker start –Ω–∞–º –Ω–µ –æ—á–µ–Ω—å –Ω—É–∂–µ–Ω –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏,
# —Ç–∞–∫ –∫–∞–∫ –º—ã –±—É–¥–µ–º –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å–∞–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–æ–º–∞–Ω–¥–æ–π docker stop.
# –ù–æ –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã –∫–∞—Ä—Ç–∏–Ω—ã –º–æ–∂–Ω–æ –µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.
PID_DOCKER=$!

echo "–ó–∞–ø—É—Å–∫–∞–µ–º npm start..."
npm start &
PID_NPM=$! # –°–æ—Ö—Ä–∞–Ω—è–µ–º PID (ID –ø—Ä–æ—Ü–µ—Å—Å–∞) –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ñ–æ–Ω–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã

echo "–ó–∞–ø—É—Å–∫–∞–µ–º poetry run python main.py..."
poetry run python main.py &
PID_MAIN=$!

echo "–ó–∞–ø—É—Å–∫–∞–µ–º poetry run python api/emulator.py..."
poetry run python api/emulator.py &
PID_EMULATOR=$!

echo ""
echo "‚úÖ –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω—ã."
echo "üõë –ù–∞–∂–º–∏—Ç–µ Ctrl+C, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏—Ö –≤—Å–µ."

# –ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ, —á—Ç–æ–±—ã —Å–∫—Ä–∏–ø—Ç –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è.
# –û–Ω –±—É–¥–µ—Ç –∂–¥–∞—Ç—å, –ø–æ–∫–∞ –Ω–µ –±—É–¥—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω—ã —Ñ–æ–Ω–æ–≤—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
# –∏–ª–∏ –ø–æ–∫–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç trap.
wait